<!DOCTYPE html>
<html>

<head>
    <title>LanGenius - Transfer file easily</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,  initial-scale=1.0">
    <script type="text/javascript">
    function initMe() {
        if (navigator.language == "zh-CN") {
            if (document.getElementById('btCopy') != null) { document.getElementById('btCopy').value = "复制" }
            if (document.getElementById('btSend') != null) { document.getElementById('btSend').value = "发送" }
            if (document.getElementById('txtClipboard') != null) { document.getElementById('txtClipboard').innerHTML = '剪切板' }
            if (document.getElementById('txtBindClip') != null) { document.getElementById('txtBindClip').innerHTML = '绑定' }
            document.getElementById('txtFiles').innerHTML = '文件'
            document.getElementById('liveStreamPage').innerHTML = '直播页面'
            window.Succeed = '成功'
            document.getElementById('submit_button').value = '上传文件'
            var as = document.getElementsByClassName("downloadA")
            for (var i = 0; i < as.length; i++) {
                as[i].innerHTML = '下载'
            }
        } else {
            window.Succeed = ' Succeed'
        }
        if (getCookie("LanGenius-Bind-Clipboard") == "checked") {
            document.getElementById("btBind").checked = true
            BindClipboard()
        }
        //detect link
        detectLink()
    }
    function detectLink() {
        if (document.getElementById("cb")==null) {
            return
        }
        var cb = document.getElementById("cb").value
        var link = ''
        if (cb.indexOf("http://") > -1) {
            var end = cb.indexOf(" ", cb.indexOf("http://"))
            link = cb.substring(cb.indexOf('http://'), end == -1 ? cb.length : end)
        } else if (cb.indexOf('https://') > -1) {
            var end = cb.indexOf(" ", cb.indexOf("https://"))
            link = cb.substring(cb.indexOf('https://'), end == -1 ? cb.length : end)
        }
        if (link != '') {
            if (navigator.language == 'zh-CN') {
                document.getElementById('openUrl').innerHTML = '打开网址'
            } else {
                document.getElementById('openUrl').innerHTML = 'Open URL'
            }
            document.getElementById('openUrl').href = link
        }else {
            document.getElementById('openUrl').innerHTML = ''
        }
    }

    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    function copy() {
        detectLink()
        var me = document.getElementById("btCopy")
        var cb = document.getElementById("cb")
        cb.select()
        document.execCommand("Copy")
        var myvalue = me.value
        me.value = window.Succeed
        me.disabled = 'disabled'
        setTimeout("document.getElementById('btCopy').value='" + myvalue + "';document.getElementById('btCopy').disabled=''", 1000)
    }

    function send() {
        var me = document.getElementById("btSend")
        var myvalue = me.value
        var str = document.getElementById("cb").value
        var xhr = new XMLHttpRequest()
        var fd = new FormData()
        var obj = new Object()
        obj.Cb = str
        fd.append('cb', JSON.stringify(obj))
        xhr.onload = function(e) {
            if (this.status == 200 || this.status == 302 || this.status == 304) {
                me.value = window.Succeed
                me.disabled = 'disabled'
                setTimeout("document.getElementById('btSend').value='" + myvalue + "';document.getElementById('btSend').disabled='';", 1000)
            }
        }
        xhr.open("POST", "/send", true)
        xhr.send(fd)
        console.log('sent clip')
    }

    function DoUpload() {
        var fd = new FormData()
        var file = document.getElementById("myUploadFile")
        for (var i = 0; i < file.files.length; i++) {
            fd.append("myUploadFile", file.files[i])
        }

        uploading()
        var xhr = new XMLHttpRequest()
        xhr.upload.addEventListener("progress", function(evt) {
            if (evt.lengthComputable) {
                var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                document.getElementById("uploadProgress").value = percentComplete
                document.getElementById('result').innerHTML = percentComplete.toString() + '%';
            } else {
                document.getElementById('result').innerHTML = 'unable to compute';
            }
        }, false)
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                document.getElementById("result").innerHTML = xhr.responseText;
                setTimeout('uploadDone()', 1000)
            }
        }
        xhr.addEventListener("load", function(evt) {
            document.getElementById("result").innerHTML = evt.target.responseText
            setTimeout('uploadDone()', 1000)
        }, false)
        xhr.addEventListener("error", function(evt) {
            document.getElementById("result").innerHTML = "Something went wrong ."
            setTimeout('uploadDone()', 1000)
        }, false)
        xhr.addEventListener("abort", function(evt) {
            document.getElementById("result").innerHTML = "Abort ."
            setTimeout('uploadDone()', 1000)
        }, false)
        xhr.open("POST", "/upload")
        xhr.send(fd)
    }

    function uploading() {
        if (navigator.language == "zh-CN") {
            document.getElementById("submit_button").value = '上传中...'
        } else {
            document.getElementById("submit_button").value = 'Uploading'
        }
        document.getElementById("submit_button").disabled = 'disabled'
        document.getElementById("myUploadFile").disabled = 'disabled'
    }

    function uploadDone() {
        document.getElementById("uploadProgress").value = 0
        if (navigator.language == "zh-CN") {
            document.getElementById("submit_button").value = '上传文件'
        } else {
            document.getElementById("submit_button").value = 'Upload'
        }
        document.getElementById("submit_button").disabled = ''
        document.getElementById("myUploadFile").disabled = ''
    }

    function BindClipboard() {
        var me = document.getElementById("btBind")
        if (me.checked) {
            setCookie("LanGenius-Bind-Clipboard", "checked", 365)
            window.wsBind = new WebSocket("ws://" + location.href.split("/")[2] + "/wsClipboard")
            window.wsBind.onmessage = function(e) {
                var gobj = JSON.parse(e.data)
                document.getElementById("cb").value = gobj.Content
                copy()
            }
            window.wsBind.onopen = function() {
                console.log('bind open')
            }
            window.wsBind.onerror = function(e) {
                console.log('bind err:' + e.data)
            }
            window.wsBind.onclose = function() {
                console.log('bind closed')
                window.wsBind = null
            }
        } else {
            setCookie("LanGenius-Bind-Clipboard", "unchecked", 365)
            if (window.wsBind != null) {
                window.wsBind.close()
                window.wsBind = null
            }
        }
    }

    function clipOnChange(me) {
        console.log('onchange')
        detectLink()
        if (window.wsBind != null) {
            var obj = new Object()
            obj.Content = me.value
            window.wsBind.send(JSON.stringify(obj))
            console.log('bind sent')
        }
    }
    setTimeout("initMe()", 50)
    </script>
    <style type="text/css">
    .wrapper {
        background-color: #fff;
        display: inline-block;
        padding: 5px;
        box-shadow: 2px 2px 10px #000;
        border-radius: 10px;
    }
    </style>
</head>

<body style="background-color: #58c6d5;font-family: sans-serif;padding: 10px;margin: 0px;">
    <center>
        {{if .ClipboardEnabled}}
        <div class="wrapper">
            <table>
                <tr>
                    <th style="color: #D81B60" id="txtClipboard">Clipboard</th>
                </tr>
                <tr align="center">
                    <td>
                        <textarea name="cb" id="cb" cols="30" rows="5" onkeyup="clipOnChange(this)">{{.Clipboard}}</textarea>
                    </td>
                    <td>
                        <a href="" id="openUrl" target="_blank"></a>
                        <br>
                        <input type="button" value="Copy" id="btCopy" onclick="copy(this)">
                        <br>
                        <input type="button" value="Send" id="btSend" onclick="send(this)">
                        <br>
                        <input type="checkbox" id="btBind" onchange="BindClipboard(this)"><span id="txtBindClip">Bind</span>
                    </td>
                    <td><span id="spanInfo"></span>
                        <br><span></span></td>
                </tr>
                <tr>
                    <td colspan="2">
                        <hr>
                    </td>
                </tr>
            </table>
        </div>
        {{end}}
        <br>
        <br>
        <div class="wrapper">
            <table>
                <tr>
                    <th style="color: #1E88E5" id="txtFiles">Files</th>
                </tr>
                <tr>
                    <td colspan="2">
                        {{range .Files}}
                        <a href="/viewfile/{{.Name}}">{{.Name}}</a>
                        <a href="/download/{{.Name}}" class="downloadA">Download</a>
                        <br> {{end}}
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <hr>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="file" name="myUploadFile" id="myUploadFile" onchange="document.getElementById('submit_button').disabled=''" multiple="multiple">
                        <input type="button" id="submit_button" disabled value="Upload" onclick="DoUpload()">
                    </td>
                </tr>
                <tr>
                    <td>
                        <progress value="0" max="100" id="uploadProgress" style="height: 4px; width: 100%"></progress>
                        <div id="result"></div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <a href="/live" id="liveStreamPage">Live Page</a>
                    </td>
                </tr>
            </table>
        </div>
        <br>
    </center>
</body>

</html>